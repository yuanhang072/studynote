# 软件复杂度来源

## 高性能

> 高性能是什么？

性能是软件的一个重要质量属性。衡量软件性能包括了响应时间、TPS、服务器资源利用率等客观指标，也可以是用户的主观感受.

> 为什么需要高性能？

追求良好的用户体验；满足业务增长的需要。

> 如何做好高性能?

可以从垂直与水平两个维度来考虑。

垂直维度主要是针对单台计算机，通过升级软、硬件能力实现性能提升；

水平维度则主要针对集群系统，利用合理的任务分配与任务分解实现性能的提升。

> 高性能引起复杂度体现的主要方面：

- 单台计算机内部为了高性能带来的复杂度

  进程和线程：需要考虑（多进程、多线程、进程间通信、多线程并发等）[**进程资料**](http://concurrent.redspider.group/article/01/2.html)

  ~~~xml
  Nginx 可以用多进程也可以用多线程，
  JBoss 采用的是多线程；
  Redis 采用的是单进程，
  Memcache 采用的是多线程，
  这些系统都实现了高性能，但内部实现差异却很大。
  ~~~

- 多台计算机集群为了高性能带来的复杂度

  任务分配方式：指每台机器都可以处理完整的业务任务，不同的任务分配到不同的机器上执行。

  ~~~xml
  主要体现：1、增加一个任务分配器，硬件网络设备（F5、交换机）或者负载均衡软件（Nginx等）
  		2、任务分配器和真正的业务服务器之间有连接和交互
  		3、任务分配器需要增加分配算法。例如，是采用轮询算法，还是按权重分配，又或者按照负载进行分配。
  ~~~

  任务分解方式：把原来大一统但复杂的业务系统，拆分成小而简单但需要多个系统配合的业务系统。

  ~~~xml
  简单的系统更加容易做到高性能
  可以针对单个任务进行扩展
  ~~~


> 一般解决方式：

垂直维度可包括以下措施：
		增大内存减少I/O操作
		更换为固态硬盘（SSD）提升I/O访问速度
		使用RAID增加I/O吞吐能力
		置换服务器获得更多的处理器或分配更多的虚拟核
		升级网络接口或增加网络接口
水平维度可包括以下措施：
		功能分解：基于功能将系统分解为更小的子系统
		多实例副本：同一组件重复部署到多台不同的服务器
		数据分割：在每台机器上都只部署一部分数据

> 后话：

业务早期阶段可采用垂直维度提升性能，达到一定业务阶段，水平维度提升性能是必经之路。

## 高可用

> 高可用是什么？

系统无中断地执行其功能的能力，代表系统的可用性程度，是进行系统设计时的准则之一。**本质上都是通过“冗余”来实现高可用**！

> 与高性能的区别？

单纯从形式上来看，和高性能是一样的，都是通过增加更多机器来达到目的。

但其实本质上是有根本区别的：**高性能增加机器目的在于“扩展”处理性能；高可用增加机器目的在于“冗余”处理单元。**

> 高可用引起的复杂度方面：

- 计算高可用

  这里的“计算”指的是业务的逻辑处理。计算有一个特点就是无论在哪台机器上进行计算，同样的算法和输入数据，产出的结果都是一样的，所以将计算从一台机器迁移到另外一台机器，对业务并没有什么影响。

  从单机--------------(主备、主主)--------------->双机------（1 主 3 备、2 主 2 备、3 主 1 备、4主 0）------>集群

  ​																	                         （ZooKeeper 采用的就是 1 主多备）

- 存储高可用

  CAP（一致性、可用性、分区容错性）理论，从理论上论证了存储高可用的复杂度，即不可能同时满足“一致性、可用性、分区容错性”，最多满足其中两个。



- 高可用状态决策

  无论是计算高可用还是存储高可用，其基础都是“状态决策”，即系统需要能够判断当前的状态是正常还是异常。通过冗余来实现的高可用系统，状态决策本质上就不可能做到完全正确。

  ```xml
  1. 独裁式:不会出现决策混乱的问题,当决策者本身故障时,整个系统就无法实现准确的状态决策。
  2. 协商式:是两个独立的个体通过交流信息，然后根据规则进行决策，最常用的协商式决策就是主备决策。在某些场景总是存在一些问题。
  3. 民主式:多个独立的个体通过投票的方式来进行状态决策。例如，ZooKeeper 集群在选举 leader 时就是采用这种方式。但是会存在“脑裂”的情况。为了解决脑裂问题，民主式决策的系统一般都采用“投票节点数必须超过系统总节点数一半”规则来处理。
  ```

  

## 可扩展性

> 什么是可扩展性？

可扩展性指系统为了应对将来需求变化而提供的一种扩展能力，当有新的需求出现时，系统不需要或者仅需要少量修改就可以支持，无须整个系统重构或者重建。

> 如何设计良好的可扩展性的系统

有两个基本条件：正确预测变化、完美封装变化。

- 预测变化：

  ~~~xml
  复杂来源：
  - 不能每个设计点都考虑可扩展性。
  - 不能完全不考虑可扩展性。
  - 所有的预测都存在出错的可能性。
  ~~~

- 应对变化：

  ~~~xml
  复杂来源：
  - 系统需要拆分出变化层和稳定层
  - 需要设计变化层和稳定层之间的接口
  
  第一种应对变化的常见方案是将“变化”封装在一个“变化层”，将不变的部分封装在一个独立的“稳定层”。
  第二种常见的应对变化的方案是提炼出一个“抽象层”和一个“实现层”。
  ~~~



## 低成本、安全、规模

- 低成本

  当我们设计“高性能”“高可用”的架构时，通用的手段都是增加更多服务器来满足“高性能”和“高可用”的要求；而低成本正好与此相反，我们需要减少服务器的数量才能达成低成本的目标。

  一般中小公司基本都是靠引入新技术来达到低成本的目标；而大公司更有可能自己去创造新的技术来达到低成本的目标。

- 安全

  1. 功能安全

     常见的 XSS 攻击、CSRF 攻击、SQL 注入

  2. 架构安全

     传统的架构安全主要依靠防火墙，互联网系统的架构安全目前并没有太好的设计手段来实现，更多地是依靠运营商
     或者云服务商强大的带宽和流量清洗的能力，较少自己来设计和实现。

- 规模
  1. 功能越来越多，导致系统复杂度指数级上升
  2. 数据越来越多，系统复杂度发生质变
